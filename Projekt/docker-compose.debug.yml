services:
  mqtt_publisher:
    image: eclipse-mosquitto
    ports:
      - "1883:1883"

  sender:
    build: .
    environment:
      - MQTT_BROKER=167.172.164.168
      - MQTT_PORT=1883
      - LOCATION=2178

  weather_requester:
    build: ./
    container_name: weather_requester_debug
    environment:
      - LOCATION=2178
    volumes:
      - .:/app
    ports:
      - "5678:5678"
    command: ["python", "-m", "debugpy", "--wait-for-client", "--listen", "0.0.0.0:5678", "main.py"]

  flask_app:
    build: .
    container_name: flask_domain
    ports:
      - "9361:9361"
    volumes:
      - ./data:/app/data
    environment:
      - FLASK_APP=weather_requester.py
      - FLASK_ENV=development
    command: flask run --host=0.0.0.0 --port=9361
    depends_on:
      - weather_requester

healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:9361"]
  interval: 30s
  retries: 3
